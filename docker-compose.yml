name: homesite

services:
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 20

  mongo:
    image: mongo:7
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 20

  # One-shot migrator (run on demand, or as a dependency before auth-api starts)
  auth-ef-migrations:
    build:
      context: ./backend
      dockerfile: Auth.Api/Dockerfile
      target: build
    working_dir: /src
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=server=mysql;port=3306;database=${MYSQL_DATABASE};user=${MYSQL_USER};password=${MYSQL_PASSWORD}
      - Jwt__Key=${JWT_KEY}
    depends_on:
      mysql:
        condition: service_healthy
    command:
      [
        "/bin/sh",
        "-lc",
        "set -eux;
        dotnet --info;
        dotnet tool install -g dotnet-ef;
        /root/.dotnet/tools/dotnet-ef --version;
        /root/.dotnet/tools/dotnet-ef database update --project Auth.Api/Auth.Api.csproj --startup-project Auth.Api/Auth.Api.csproj --verbose;
        echo MIGRATIONS_DONE;"
      ]

  auth-api:
    build:
      context: ./backend
      dockerfile: Auth.Api/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=server=mysql;port=3306;database=${MYSQL_DATABASE};user=${MYSQL_USER};password=${MYSQL_PASSWORD}
      - Mongo__ConnectionString=mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=Auth.Api
      - Jwt__Audience=Homesite
    depends_on:
      mysql:
        condition: service_healthy
      mongo:
        condition: service_healthy
      auth-ef-migrations:
        condition: service_completed_successfully
    ports:
      - "5001:8080"

  # TODO make Recipes.Api and get it running

  web-bff-api:
    build:
      context: ./backend
      dockerfile: Web.Bff.Api/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - Services__Auth=http://auth-api:8080/
      - Services__Recipes=http://recipes-api:6000/
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=Auth.Api
      - Jwt__Audience=Homesite
    depends_on:
      auth-api:
        condition: service_started
    ports:
      - "5002:8080"

  gateway-api:
    build:
      context: ./backend
      dockerfile: Gateway.Api/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - Cors__AllowedOrigins__0=http://localhost:3000
      - Cors__AllowedOrigins__1=http://localhost:5173
      # if gateway needs internal service discovery, add env vars here similarly
    depends_on:
      auth-api:
        condition: service_started
      web-bff-api:
        condition: service_started
    ports:
      - "5000:8080"

  recipes-api:
    build:
      context: ./backend/recipes-api
      dockerfile: Dockerfile
    image: homesite-recipes-api
    environment:
      # - ENVIRONMENT=Docker
      - SPRING_DATA_MONGODB_URI=mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/RecipesDb?authSource=admin
      - SPRING_DATA_MONGODB_HOST=mongo
      - SPRING_DATA_MONGODB_PORT=27017
      - SPRING_DATA_MONGODB_DATABASE=RecipesDb
      - JWT_KEY=${JWT_KEY}
      - JWT_ISSUER=Auth.Api
      - JWT_AUDIENCE=Homesite
      - SERVER_PORT=6000
    depends_on:
      mongo:
        condition: service_healthy
      auth-api:
        condition: service_started
      web-bff-api:
        condition: service_started
      gateway-api:
        condition: service_started
    ports:
      - "6001:6000"


  frontend:
    build:
      context: ./frontend
    ports:
      - "3000:80"
    depends_on:
      gateway-api:
        condition: service_started
    environment:
      # IMPORTANT: browser should call localhost, not docker DNS
      - API_BASE_URL=${API_BASE_URL}

volumes:
  mysql_data:
  mongo_data:
